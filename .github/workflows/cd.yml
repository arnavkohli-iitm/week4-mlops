name: CD - Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: "warm-cycle-351713"
  REGION: "us-east1"
  ZONE: "us-east1-b"
  CLUSTER_NAME: "mlops-cluster2"
  IMAGE_PATH: "us-east1-docker.pkg.dev/warm-cycle-351713/mlops-repo/iris-api"

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure Docker
        # This now uses the new us-east1 region
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          export IMAGE_TAG=${{ github.sha }}
          
          docker build .             --file Dockerfile             --tag ${{ env.IMAGE_PATH }}:${{ env.IMAGE_PATH }}             --tag ${{ env.IMAGE_PATH }}:latest
            
          docker push ${{ env.IMAGE_PATH }}:${{ env.IMAGE_PATH }}
          docker push ${{ env.IMAGE_PATH }}:latest

  deploy:
    name: Deploy and Stress Test
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Get GKE cluster credentials
        uses: 'google-github-actions/get-gke-credentials@v2'
        with:
          # Updated to use the new env variables
          cluster_name: "${{ env.CLUSTER_NAME }}"
          location: "${{ env.ZONE }}"

      - name: Update image tag in deployment
        run: |
          export IMAGE_TAG=${{ github.sha }}
          export FINAL_IMAGE_PATH=${{ env.IMAGE_PATH }}:${{ env.IMAGE_PATH }}
          
          sed -i "s|__IMAGE__|$FINAL_IMAGE_PATH|g" k8s/deployment.yaml
          
          echo "--- New deployment.yaml ---"
          cat k8s/deployment.yaml

      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/
          kubectl rollout status deployment/iris-api-deployment

      - name: Install wrk
        run: |
          sudo apt-get update
          sudo apt-get install -y wrk

      - name: Get LoadBalancer IP
        id: get_ip
        run: |
          echo "Waiting for LoadBalancer IP..."
          COUNTER=0
          while [ $COUNTER -lt 30 ]; do
            IP=$(kubectl get service iris-api-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            if [ -n "$IP" ]; then
              echo "SERVICE_IP=$IP" >> $GITHUB_ENV
              echo "::set-output name=ip::$IP"
              echo "Found IP: $IP"
              break
            fi
            echo "IP not ready, waiting 10s..."
            sleep 10
            COUNTER=$((COUNTER + 1))
          done
          if [ -z "$IP" ]; then
            echo "Error: LoadBalancer IP not found after 5 minutes."
            exit 1
          fi

      - name: Run Stress Test (Autoscaling)
        if: steps.get_ip.outputs.ip
        run: |
          echo "Running wrk test (1000 conns) on http://${{ env.SERVICE_IP }}/predict"
          wrk -t4 -c1000 -d30s             -s k8s/wrk-post.lua             http://${{ env.SERVICE_IP }}/predict > stress-test-results-1.txt
          
          echo "--- Stress Test Results (1000 conns) ---"
          cat stress-test-results-1.txt

      - name: Observe Autoscaling
        if: always()
        run: |
          echo "--- HPA Status (Mid-Test) ---"
          kubectl get hpa iris-api-hpa
          echo "Waiting 60s for scaling to complete and metrics update..."
          sleep 60
          echo "--- HPA Status (Post-Test) ---"
          kubectl get hpa iris-api-hpa -o wide
          echo "--- Pod Status (Post-Test) ---"
          kubectl get pods -o wide

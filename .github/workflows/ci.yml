name: DVC & Pytest CI

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  test-and-validate: # Renamed job for clarity
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3' # Using the version from your original file

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Authenticate Google Cloud
        run: |
          echo "${{ secrets.GCS_SA_KEY }}" | base64 -d > gcs-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcs-key.json" >> $GITHUB_ENV

      - name: Fetch DVC data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          dvc pull

      - name: Run Pytest
        id: pytest
        continue-on-error: true # Don't stop on test failure
        run: |
          pytest > pytest-results.txt 2>&1

      # --- NEW STEP: Run Data Poisoning Experiments ---
      - name: Run Data Poisoning Experiments
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          python train.py data/iris.csv --poison_percent 0.0
          python train.py data/iris.csv --poison_percent 0.05
          python train.py data/iris.csv --poison_percent 0.10
          python train.py data/iris.csv --poison_percent 0.50
          
      # --- NEW STEP: Generate Experiment Report ---
      - name: Generate Experiment Report
        id: experiment_report
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          python scripts/generate_report.py > poison-results.md
          
      # --- MODIFIED STEP: Combine reports ---
      - name: Generate Sanity Test Report
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "## ðŸ¤– MLOps Sanity Test Report" > report.md
          echo "" >> report.md
          
          # Add poisoning results
          cat poison-results.md >> report.md
          echo "" >> report.md
          
          # Add Pytest results
          echo "### âœ… Pytest Results" >> report.md
          echo '```' >> report.md
          cat pytest-results.txt >> report.md
          echo '```' >> report.md
          
          # Kept this from your original file
          echo "### ðŸ”® Prediction Sanity Check skipped" >> report.md

      - name: Post CML Comment
        if: always() && github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cml comment create report.md
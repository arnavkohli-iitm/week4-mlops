name: CD - Build and Deploy to GKE

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: "warm-cycle-351713"
  REGION: "us-central1"
  IMAGE_PATH: "us-central1-docker.pkg.dev/warm-cycle-351713/mlops-repo/iris-api"

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          # Use the JSON key from secrets
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          # Use the short git commit SHA as the image tag
          export IMAGE_TAG=${{ github.sha }}
          
          docker build . \
            --file Dockerfile \
            --tag ${{ env.IMAGE_PATH }}:$IMAGE_TAG \
            --tag ${{ env.IMAGE_PATH }}:latest
            
          docker push ${{ env.IMAGE_PATH }}:$IMAGE_TAG
          docker push ${{ env.IMAGE_PATH }}:latest

  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: build-and-push # Wait for the build to finish

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Get GKE cluster credentials
        # This configures `kubectl` to talk to our cluster
        uses: 'google-github-actions/get-gke-credentials@v2'
        with:
          cluster_name: "mlops-cluster" # The name you gave your cluster
          location: ${{ env.REGION }}

      - name: Update image tag in deployment
        run: |
          export IMAGE_TAG=${{ github.sha }}
          export FINAL_IMAGE_PATH=${{ env.IMAGE_PATH }}:$IMAGE_TAG
          
          # This command finds the placeholder __IMAGE__ in your deployment
          # and replaces it with the real image path and tag.
          sed -i "s|__IMAGE__|$FINAL_IMAGE_PATH|g" k8s/deployment.yaml
          
          echo "--- New deployment.yaml ---"
          cat k8s/deployment.yaml

      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/iris-api-deployment

      - name: Show service IP
        run: |
          echo "Waiting 60s for LoadBalancer IP..."
          sleep 60
          kubectl get service iris-api-service
